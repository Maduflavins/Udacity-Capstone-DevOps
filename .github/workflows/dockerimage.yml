name: Docker Image CI
env:
  DOCKER_USERNAME: ${{ github.actor }}
  DOCKER_PASSWORD: ${{secrets.DOCKERHUB_PASSWORD}}
  DOCKER_REPONAME:  "capstone-bcrypt" 
on:
  push:
    branches:
      - master
    paths:
      - 'Dockerfile'
      - 'app/**'
      - '.github/**'

jobs:
  check-dockerfile:
    name: Hadolint Dockerfile
    runs-on: macOS-10.14
    timeout-minutes: 30
    steps:
      - name: Checkout git repo
        uses: actions/checkout@master
        with:
          fetch-depth: 1
      - name: Run hadolint
        run: |
          brew install hadolint
          hadolint ./Dockerfile | tee -a hadolint_lint.txt
          lintErrors=$(stat --printf="%s"  hadolint_lint.txt)
          if [ "$lintErrors" -gt "0" ]; then
              echo "Errors have been found, please see below"
              cat hadolint_lint.txt
              exit 1
          else
              echo "There are no erros found on Dockerfile!!"
          fi
        
  docker-build-bcrypt:
    name: Docker build bcrypt
    needs: [check-dockerfile]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout git repo
      uses: actions/checkout@master
    - name: Build the Docker image
      run: |
        docker build . \
        --file Dockerfile \
        --tag $DOCKER_USERNAME/$DOCKER_REPONAME:${GITHUB_SHA::7}
    - name: Set env vars
      run: |
        image_tag="$DOCKER_USERNAME/$DOCKER_REPONAME:${GITHUB_SHA::7}"
        echo "::set-env name=IMAGE_TAG::$image_tag"
   
  security-scan-bcrypt:
    name: Scan Bcrypt
    needs: [docker-build-bcrypt]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    container:
      image: aquasec/trivy:latest
    steps:
      - name: Show version (Trivy)
        uses: docker://aquasec/trivy:latest
        with:
          args: -v
      - name: Vulnerability Scan Of Docker Images With Trivy
        uses: docker://docker.io/aquasec/trivy:latest
        with:
          args: --format json --no-progress --output report.json ${{ env.IMAGE_TAG }}
      - name: Show result (JSON)
        run: cat report.json
    
  docker-push-bcrypt:
    name: Docker push bcrypt
    needs: [security-scan-bcrypt]
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
    - name: Login to Dockerhub
      run: | 
        echo $DOCKER_PASSWORD | \
        docker login https://index.docker.io/v1/ \
        --username $DOCKER_USERNAME --password-stdin
    - name: Push the Docker image
      run: |
        docker push \
        ${{ env.IMAGE_TAG }}
    
